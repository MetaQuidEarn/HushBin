<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HushBin | AI Assistant</title>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#0ea5e9',
                        'deep-think': '#8b5cf6',
                        'sidebar': '#202123',
                        'chat-bg': '#343541',
                        'input-bg': '#40414f',
                        'feature-blue': '#2563eb',
                        'feature-purple': '#7c3aed',
                        'feature-green': '#059669',
                        'feature-yellow': '#d97706',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #343541;
            color: white;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Hide scrollbar but allow scrolling */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* Mobile sidebar drawer */
        .sidebar-drawer {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-drawer.open {
            transform: translateX(0);
        }
        .sidebar-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Chat container */
        .chat-container {
            height: 100vh;
            background: #343541;
        }
        
        /* Message styles */
        .message-container {
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .message-content {
            max-width: 48rem;
            margin: 0 auto;
            padding: 0 16px;
            display: flex;
            gap: 20px;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background: #10a37f;
        }
        
        .ai-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .message-text {
            flex: 1;
            line-height: 1.75;
            color: #d1d5db;
            font-size: 16px;
            padding-top: 4px;
        }
        
        /* Input area - Mobile optimized */
        .input-container {
            background: #343541;
            padding: 16px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .input-wrapper {
            max-width: 48rem;
            margin: 0 auto;
            position: relative;
        }
        
        .message-input {
            width: 100%;
            background: #40414f;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px 20px;
            padding-right: 56px;
            padding-left: 56px;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            color: white;
            min-height: 52px;
            max-height: 120px;
        }
        
        .message-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .message-input::placeholder {
            color: #8e8ea0;
        }
        
        /* Send button */
        .send-button {
            position: absolute;
            right: 12px;
            bottom: 12px;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: #10a37f;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Deep Think Button - Left side of input */
        .deep-think-side-btn {
            position: absolute;
            left: 12px;
            bottom: 12px;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(139, 92, 246, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .deep-think-side-btn:hover {
            background: rgba(139, 92, 246, 0.2);
        }
        
        .deep-think-side-btn.active {
            background: rgba(139, 92, 246, 0.3);
            color: white;
            border-color: #8b5cf6;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #8e8ea0;
            animation: typing 1.5s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 100% { opacity: 0.5; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-4px); }
        }
        
        /* Mobile menu button */
        .mobile-menu-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            cursor: pointer;
        }
        
        /* Mobile responsive */
        @media (max-width: 640px) {
            .message-content {
                padding: 0 12px;
                gap: 12px;
            }
            
            .avatar {
                width: 32px;
                height: 32px;
            }
            
            .message-text {
                font-size: 15px;
            }
            
            .input-container {
                padding: 12px;
            }
            
            .message-input {
                padding-left: 52px;
                padding-right: 52px;
            }
        }
        
        /* AI response formatting */
        .ai-content {
            line-height: 1.75;
        }
        
        .ai-content p {
            margin-bottom: 16px;
        }
        
        .ai-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
        }
        
        .ai-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
        }
        
        .ai-content ul, .ai-content ol {
            padding-left: 20px;
            margin: 12px 0;
        }
        
        .ai-content li {
            margin-bottom: 8px;
        }
        
        /* Notification */
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Context Memory Indicator */
        .context-memory-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #10a37f;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 30;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(16, 163, 127, 0.3);
        }
        
        @media (max-width: 640px) {
            .context-memory-indicator {
                top: 60px;
                right: 10px;
                font-size: 11px;
                padding: 4px 8px;
            }
        }
        
        /* Feature Cards */
        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        
        .feature-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        .feature-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .feature-blue { background: rgba(37, 99, 235, 0.2); border: 1px solid rgba(37, 99, 235, 0.3); }
        .feature-purple { background: rgba(124, 58, 237, 0.2); border: 1px solid rgba(124, 58, 237, 0.3); }
        .feature-green { background: rgba(5, 150, 105, 0.2); border: 1px solid rgba(5, 150, 105, 0.3); }
        .feature-yellow { background: rgba(217, 119, 6, 0.2); border: 1px solid rgba(217, 119, 6, 0.3); }
        
        /* Creator Badge */
        .creator-badge {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #8b5cf6;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }
        
        /* Memory Badge */
        .memory-badge {
            background: rgba(16, 163, 127, 0.1);
            border: 1px solid rgba(16, 163, 127, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #10a37f;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Telegram WebApp Theme */
        .tg-theme-primary {
            background-color: var(--tg-theme-bg-color, #343541);
            color: var(--tg-theme-text-color, white);
        }
        
        .tg-theme-secondary {
            background-color: var(--tg-theme-secondary-bg-color, #202123);
            color: var(--tg-theme-text-color, white);
        }
        
        .tg-theme-button {
            background-color: var(--tg-theme-button-color, #10a37f);
            color: var(--tg-theme-button-text-color, white);
        }
    </style>
</head>
<body class="tg-theme-primary">
    <!-- Context Memory Indicator -->
    <div id="contextMemoryIndicator" class="context-memory-indicator hidden">
        <i class="fas fa-database"></i>
        <span id="contextCount">0 messages in memory</span>
    </div>

    <!-- Sidebar Drawer for Mobile -->
    <div id="sidebarOverlay" class="fixed inset-0 z-40 sidebar-overlay hidden"></div>
    <div id="sidebarDrawer" class="sidebar-drawer fixed inset-y-0 left-0 z-50 w-64 tg-theme-secondary overflow-y-auto hide-scrollbar">
        <div class="p-4">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <span class="text-white font-semibold">HushBin</span>
                </div>
                <button id="closeSidebar" class="md:hidden p-2 text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <button id="newChatBtn" class="w-full mb-4 p-3 text-left text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg border border-gray-700">
                <i class="fas fa-plus mr-2"></i>New chat
            </button>
            
            <!-- Quick Prompts -->
            <div class="space-y-3 mb-8">
                <div class="text-sm text-gray-400 mb-2">Quick Prompts</div>
                
                <div class="p-3 bg-gray-800/50 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-800" onclick="insertExample('Write a professional email to schedule a team meeting about Q4 goals')">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-envelope text-blue-400 mr-2"></i>
                        <span class="text-white">Professional Email</span>
                    </div>
                    <p class="text-xs text-gray-400">Business communication</p>
                </div>
                
                <div class="p-3 bg-gray-800/50 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-800" onclick="insertExample('Write a short fantasy story about a lost kingdom')">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-book text-purple-400 mr-2"></i>
                        <span class="text-white">Story Writing</span>
                    </div>
                    <p class="text-xs text-gray-400">Creative storytelling</p>
                </div>
                
                <div class="p-3 bg-gray-800/50 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-800" onclick="insertExample('Generate a business idea for sustainable tech in 2024')">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-lightbulb text-green-400 mr-2"></i>
                        <span class="text-white">Business Idea</span>
                    </div>
                    <p class="text-xs text-gray-400">Startup suggestions</p>
                </div>
                
                <div class="p-3 bg-gray-800/50 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-800" onclick="insertExample('How can we reduce employee turnover in our company?')">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-puzzle-piece text-yellow-400 mr-2"></i>
                        <span class="text-white">Problem Solving</span>
                    </div>
                    <p class="text-xs text-gray-400">Find solutions</p>
                </div>
            </div>
            
            <!-- Settings -->
            <div class="space-y-2">
                <button id="settingsBtn" class="w-full p-3 text-left text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
                <button id="clearChatBtn" class="w-full p-3 text-left text-gray-300 hover:text-red-400 hover:bg-gray-800 rounded-lg">
                    <i class="fas fa-trash mr-2"></i>Clear Chat
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 hidden">
        <div class="tg-theme-secondary rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-white">Settings</h2>
                <button id="closeSettings" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Assistant Name</label>
                    <input id="aiName" type="text" class="w-full px-4 py-2.5 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-gray-600" value="HushBin">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Custom Instructions (Optional)</label>
                    <textarea id="baseInstructions" rows="4" class="w-full px-4 py-2.5 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-gray-600 resize-none" placeholder="Add custom instructions for the AI assistant. Leave empty for default behavior."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Deep Think Instructions</label>
                    <textarea id="deepThinkInstructions" rows="4" class="w-full px-4 py-2.5 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-gray-600 resize-none">When Deep Think mode is enabled, provide more detailed, analytical, and comprehensive responses. Break down complex topics step by step, consider multiple perspectives, and provide thorough explanations.</textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Context Memory Size</label>
                    <div class="flex items-center gap-4">
                        <input type="range" id="contextMemorySize" min="5" max="50" value="10" class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <span id="contextMemoryValue" class="text-green-400 font-medium">10 messages</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Number of previous messages to remember</p>
                </div>
            </div>
            
            <div class="mt-8 pt-6 border-t border-gray-800 flex justify-end space-x-3">
                <button id="cancelSettings" class="px-4 py-2 text-gray-300 hover:text-white">Cancel</button>
                <button id="saveSettings" class="px-4 py-2 tg-theme-button text-white rounded-lg hover:opacity-90">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 hidden">
        <div class="tg-theme-secondary rounded-lg max-w-md w-full p-6">
            <div class="w-12 h-12 rounded-full bg-red-900/30 flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash text-red-500"></i>
            </div>
            <h2 class="text-xl font-semibold text-white text-center mb-2">Clear Chat?</h2>
            <p class="text-gray-400 text-center mb-6">This will delete all messages in the current conversation.</p>
            <div class="flex space-x-3">
                <button id="cancelDelete" class="flex-1 px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg">
                    Cancel
                </button>
                <button id="confirmDelete" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Delete All
                </button>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-container flex flex-col">
        <!-- Header -->
        <header class="px-4 py-3 border-b border-gray-800 tg-theme-primary flex items-center justify-between md:justify-center">
            <button id="mobileMenuBtn" class="md:hidden mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <span id="aiTitle" class="text-white font-medium">HushBin</span>
            </div>
            
            <div class="w-10 md:hidden"></div> <!-- Spacer for alignment -->
        </header>

        <!-- Messages Area -->
        <div id="chatLog" class="flex-1 overflow-y-auto hide-scrollbar pb-40">
            <!-- Welcome Message -->
            <div class="message-container" style="border-bottom: none;">
                <div class="message-content">
                    <div class="avatar ai-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-text">
                        <div class="ai-content">
                            <!-- Main Title -->
                            <div class="mb-6">
                                <h1 class="text-2xl font-bold text-white mb-2">Hello! I'm <span class="bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">HushBin</span> ðŸ‘‹</h1>
                                <div class="creator-badge">
                                    <i class="fas fa-code"></i>
                                    <span>By <a href="https://t.me/sakibalhasannaim" target="_blank" class="hover:text-white transition-colors">Sakib Al Hasan Naim</a></span>
                                </div>
                            </div>
                            
                            <!-- Introduction -->
                            <p class="text-gray-300 mb-6">I'm your AI assistant here to help with various tasks. Let's explore what I can do for you!</p>
                            
                            <!-- Feature Cards -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                <!-- Professional Email -->
                                <div class="feature-card">
                                    <div class="feature-icon feature-blue">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <h3 class="font-semibold text-white mb-1">Professional Email</h3>
                                    <p class="text-sm text-gray-400">Craft business communications with professional tone</p>
                                </div>
                                
                                <!-- Story Writing -->
                                <div class="feature-card">
                                    <div class="feature-icon feature-purple">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <h3 class="font-semibold text-white mb-1">Story Writing</h3>
                                    <p class="text-sm text-gray-400">Create engaging stories and creative content</p>
                                </div>
                                
                                <!-- Business Idea -->
                                <div class="feature-card">
                                    <div class="feature-icon feature-green">
                                        <i class="fas fa-lightbulb"></i>
                                    </div>
                                    <h3 class="font-semibold text-white mb-1">Business Idea</h3>
                                    <p class="text-sm text-gray-400">Generate innovative startup suggestions</p>
                                </div>
                                
                                <!-- Problem Solving -->
                                <div class="feature-card">
                                    <div class="feature-icon feature-yellow">
                                        <i class="fas fa-puzzle-piece"></i>
                                    </div>
                                    <h3 class="font-semibold text-white mb-1">Problem Solving</h3>
                                    <p class="text-sm text-gray-400">Find solutions to complex challenges</p>
                                </div>
                            </div>
                            
                            <!-- Memory Badge -->
                            <div class="memory-badge">
                                <i class="fas fa-brain"></i>
                                <span>Remembers <span id="welcomeMemorySize" class="font-bold">10</span> previous messages</span>
                            </div>
                            
                            <!-- Quick Start -->
                            <p class="text-sm text-gray-400 mt-6">
                                <i class="fas fa-bolt text-yellow-400 mr-1"></i>
                                Pro tip: Try the quick prompts in the sidebar or type your message below to get started!
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <div class="input-wrapper">
                <!-- Deep Think Button on Left -->
                <button id="deepThinkSideBtn" class="deep-think-side-btn" title="Toggle Deep Think Mode">
                    <i class="fas fa-brain"></i>
                </button>
                
                <textarea id="promptInput" rows="1"
                    class="message-input resize-none focus:outline-none focus:ring-0"
                    placeholder="Type your message here..."
                    oninput="autoResize(this)"></textarea>
                
                <button id="sendBtn"
                    class="send-button tg-theme-button"
                    onclick="generateContent()">
                    <i id="sendIcon" class="fas fa-paper-plane"></i>
                    <i id="loadingSpinner" class="fas fa-spinner fa-spin hidden"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Telegram WebApp Initialization
        let tg = null;
        try {
            tg = window.Telegram.WebApp;
            if (tg) {
                tg.expand();
                tg.enableClosingConfirmation();
                
                // Apply Telegram theme
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#343541');
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || 'white');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#202123');
                document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#10a37f');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || 'white');
            }
        } catch (error) {
            console.log("Not running in Telegram WebApp, using standalone mode");
        }

        // API Configuration
        const apiKey = "AIzaSyDUUaYAHFYJEDy6TyRRk3kwyAW9Bl86gvA";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

        // DOM Elements
        const promptInput = document.getElementById('promptInput');
        const sendBtn = document.getElementById('sendBtn');
        const sendIcon = document.getElementById('sendIcon');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const chatLog = document.getElementById('chatLog');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebarDrawer = document.getElementById('sidebarDrawer');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const closeSidebar = document.getElementById('closeSidebar');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const deepThinkSideBtn = document.getElementById('deepThinkSideBtn');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const cancelSettings = document.getElementById('cancelSettings');
        const saveSettings = document.getElementById('saveSettings');
        const aiName = document.getElementById('aiName');
        const baseInstructions = document.getElementById('baseInstructions');
        const deepThinkInstructions = document.getElementById('deepThinkInstructions');
        const aiTitle = document.getElementById('aiTitle');
        const contextMemoryIndicator = document.getElementById('contextMemoryIndicator');
        const contextCount = document.getElementById('contextCount');
        const contextMemorySize = document.getElementById('contextMemorySize');
        const contextMemoryValue = document.getElementById('contextMemoryValue');
        const welcomeMemorySize = document.getElementById('welcomeMemorySize');
        
        // State
        let isDeepThinkMode = false;
        let isMobile = window.innerWidth < 768;
        let conversationHistory = [];
        let maxContextMemory = 10;
        let currentChatId = `chat_${Date.now()}`;
        
        // Storage Keys
        const STORAGE_KEYS = {
            CHAT_HISTORY: 'hushbin_chat_history',
            SETTINGS: 'hushbin_settings',
            ACTIVE_CHAT: 'hushbin_active_chat',
            CHATS_LIST: 'hushbin_chats_list'
        };

        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        // Check if mobile
        function checkMobile() {
            isMobile = window.innerWidth < 768;
        }
        
        // Toggle sidebar
        function toggleSidebar() {
            sidebarDrawer.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
            document.body.style.overflow = sidebarDrawer.classList.contains('open') ? 'hidden' : '';
        }
        
        // Close sidebar
        function closeSidebarFunc() {
            sidebarDrawer.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        // Telegram Cloud Storage Functions
        async function saveToTelegramStorage(key, data) {
            if (tg && tg.CloudStorage) {
                try {
                    await tg.CloudStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error("Telegram Cloud Storage error:", error);
                    return false;
                }
            }
            return false;
        }
        
        async function loadFromTelegramStorage(key) {
            if (tg && tg.CloudStorage) {
                try {
                    const data = await tg.CloudStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error("Telegram Cloud Storage error:", error);
                    return null;
                }
            }
            return null;
        }
        
        async function removeFromTelegramStorage(key) {
            if (tg && tg.CloudStorage) {
                try {
                    await tg.CloudStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error("Telegram Cloud Storage error:", error);
                    return false;
                }
            }
            return false;
        }
        
        // Fallback to localStorage if Telegram storage is not available
        function saveToStorage(key, data) {
            if (tg && tg.CloudStorage) {
                return saveToTelegramStorage(key, data);
            } else {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error("LocalStorage error:", error);
                    return false;
                }
            }
        }
        
        function loadFromStorage(key) {
            if (tg && tg.CloudStorage) {
                return loadFromTelegramStorage(key);
            } else {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error("LocalStorage error:", error);
                    return null;
                }
            }
        }
        
        // Load chat history from storage
        async function loadChatHistory() {
            const savedHistory = await loadFromStorage(STORAGE_KEYS.CHAT_HISTORY);
            if (savedHistory && savedHistory[currentChatId]) {
                conversationHistory = savedHistory[currentChatId];
                renderChatHistory();
                updateContextMemoryIndicator();
            }
        }
        
        // Save chat history to storage
        async function saveChatHistory() {
            const allChats = await loadFromStorage(STORAGE_KEYS.CHAT_HISTORY) || {};
            allChats[currentChatId] = conversationHistory;
            
            // Update chats list
            const chatsList = await loadFromStorage(STORAGE_KEYS.CHATS_LIST) || [];
            if (!chatsList.includes(currentChatId)) {
                chatsList.push(currentChatId);
                saveToStorage(STORAGE_KEYS.CHATS_LIST, chatsList);
            }
            
            saveToStorage(STORAGE_KEYS.CHAT_HISTORY, allChats);
            saveToStorage(STORAGE_KEYS.ACTIVE_CHAT, currentChatId);
        }
        
        // Render chat history to UI
        function renderChatHistory() {
            chatLog.innerHTML = '';
            
            // Add welcome message
            const welcomeMsg = document.querySelector('.message-container:first-child');
            if (welcomeMsg) {
                chatLog.appendChild(welcomeMsg.cloneNode(true));
            }
            
            // Add conversation history
            conversationHistory.forEach(msg => {
                if (msg.role === 'user') {
                    appendMessageToUI(msg.content, 'user');
                } else if (msg.role === 'assistant') {
                    appendMessageToUI(msg.content, 'ai');
                }
            });
            
            // Scroll to bottom
            setTimeout(() => {
                chatLog.scrollTop = chatLog.scrollHeight;
            }, 100);
        }
        
        // Load settings
        async function loadSettings() {
            const savedSettings = await loadFromStorage(STORAGE_KEYS.SETTINGS);
            
            if (savedSettings) {
                aiName.value = savedSettings.name || 'HushBin';
                baseInstructions.value = savedSettings.baseInstructions || '';
                deepThinkInstructions.value = savedSettings.deepThinkInstructions || deepThinkInstructions.value;
                contextMemorySize.value = savedSettings.maxContextMemory || 10;
                maxContextMemory = parseInt(savedSettings.maxContextMemory || 10);
            } else {
                aiName.value = 'HushBin';
                baseInstructions.value = '';
                deepThinkInstructions.value = deepThinkInstructions.value;
                contextMemorySize.value = 10;
                maxContextMemory = 10;
            }
            
            contextMemoryValue.textContent = `${maxContextMemory} messages`;
            welcomeMemorySize.textContent = maxContextMemory;
            aiTitle.textContent = aiName.value;
        }
        
        // Save settings
        async function saveCurrentSettings() {
            const settings = {
                name: aiName.value,
                baseInstructions: baseInstructions.value,
                deepThinkInstructions: deepThinkInstructions.value,
                maxContextMemory: contextMemorySize.value
            };
            
            maxContextMemory = parseInt(contextMemorySize.value);
            contextMemoryValue.textContent = `${maxContextMemory} messages`;
            welcomeMemorySize.textContent = maxContextMemory;
            aiTitle.textContent = aiName.value;
            
            saveToStorage(STORAGE_KEYS.SETTINGS, settings);
            updateContextMemoryIndicator();
            showNotification("Settings saved successfully");
        }
        
        // Show notification
        function showNotification(message) {
            // Remove existing notification
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'notification fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2.5 bg-[#202123] text-white rounded-lg text-sm shadow-lg border border-gray-800';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }
        
        // Toggle Deep Think mode
        function toggleDeepThinkMode() {
            isDeepThinkMode = !isDeepThinkMode;
            deepThinkSideBtn.classList.toggle('active', isDeepThinkMode);
            
            if (isDeepThinkMode) {
                deepThinkSideBtn.innerHTML = '<i class="fas fa-brain"></i>';
                deepThinkSideBtn.title = "Deep Think Mode ON";
                showNotification("Deep Think mode enabled - Detailed responses activated");
            } else {
                deepThinkSideBtn.innerHTML = '<i class="fas fa-brain"></i>';
                deepThinkSideBtn.title = "Toggle Deep Think Mode";
                showNotification("Deep Think mode disabled");
            }
        }
        
        // Get system instruction
        function getSystemInstruction() {
            const defaultInstruction = `You are HushBin (always spell it as HushBin in English), a helpful AI assistant.

Your name is HushBin and you should always identify as HushBin.

Greeting Rules:
- When users greet you with Islamic greetings (such as Assalamu Alaikum, Salam, As-salamu alaykum, etc.), respond with appropriate Islamic greetings (like Wa Alaikum Assalam, Walaykumus Salam).
- For general greetings (like hi, hello, good morning, etc.), respond with general greetings (like Hello, Hi, Good morning) and then introduce yourself as HushBin.
- NEVER respond to general greetings like "hi" with Islamic greetings like "Walaykumus Salam". Only use Islamic greetings when the user uses them first.

General Behavior:
Be respectful and helpful in all responses. For Islamic topics, respond with appropriate Islamic knowledge. For general topics, be natural and helpful.`;

            let instruction = baseInstructions.value.trim();
            
            if (!instruction) {
                instruction = defaultInstruction;
            }
            
            if (isDeepThinkMode) {
                instruction += "\n\n" + deepThinkInstructions.value;
            }
            
            return instruction;
        }
        
        // Update context memory indicator
        function updateContextMemoryIndicator() {
            if (conversationHistory.length > 0) {
                contextMemoryIndicator.classList.remove('hidden');
                contextCount.textContent = `${conversationHistory.length} messages in memory`;
            } else {
                contextMemoryIndicator.classList.add('hidden');
            }
        }
        
        // Append message to UI only
        function appendMessageToUI(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-container';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = `avatar ${sender === 'user' ? 'user-avatar' : 'ai-avatar'}`;
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            messageContent.appendChild(avatar);
            
            // Message text
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'ai-content';
            
            // Format text
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
                
            contentDiv.innerHTML = `<p>${formattedText}</p>`;
            messageText.appendChild(contentDiv);
            messageContent.appendChild(messageText);
            messageDiv.appendChild(messageContent);
            chatLog.appendChild(messageDiv);
            
            // Scroll to bottom
            setTimeout(() => {
                chatLog.scrollTop = chatLog.scrollHeight;
            }, 10);
            
            // Update context memory indicator
            updateContextMemoryIndicator();
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) typingIndicator.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-container';
            messageDiv.id = 'typingIndicator';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar ai-avatar';
            avatar.innerHTML = '<i class="fas fa-robot"></i>';
            messageContent.appendChild(avatar);
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                typingDiv.appendChild(dot);
            }
            
            const typingText = document.createElement('span');
            typingText.className = 'ml-2 text-sm text-gray-400';
            typingText.textContent = isDeepThinkMode ? 'Thinking deeply...' : 'Thinking...';
            typingDiv.appendChild(typingText);
            
            messageText.appendChild(typingDiv);
            messageContent.appendChild(messageText);
            messageDiv.appendChild(messageContent);
            chatLog.appendChild(messageDiv);
            
            setTimeout(() => {
                chatLog.scrollTop = chatLog.scrollHeight;
            }, 10);
        }
        
        // Set loading state
        function setUILoading(isLoading) {
            sendBtn.disabled = isLoading;
            promptInput.disabled = isLoading;
            deepThinkSideBtn.disabled = isLoading;
            
            if (isLoading) {
                sendIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                showTypingIndicator();
            } else {
                sendIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
            }
        }
        
        // Get recent conversation history (respecting max context memory)
        function getRecentConversationHistory() {
            if (conversationHistory.length <= maxContextMemory) {
                return conversationHistory;
            }
            
            // Keep only the most recent messages
            const recentHistory = conversationHistory.slice(-maxContextMemory);
            return recentHistory;
        }
        
        // Fetch content from API
        async function fetchContent(userQuery) {
            setUILoading(true);
            
            // Add user message to conversation history
            conversationHistory.push({
                role: 'user',
                content: userQuery
            });
            
            // Get recent history (respecting memory limit)
            const recentHistory = getRecentConversationHistory();
            
            // Prepare conversation history for API
            const contents = recentHistory.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: [{ text: msg.content }]
            }));
            
            const payload = {
                contents: contents,
                systemInstruction: { 
                    parts: [{ 
                        text: getSystemInstruction()
                    }] 
                },
                generationConfig: {
                    temperature: isDeepThinkMode ? 0.2 : 0.7,
                    maxOutputTokens: isDeepThinkMode ? 4000 : 2000,
                    topP: 0.95,
                    topK: 40
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                let text = "I apologize, I could not generate a response at this time. Please try again.";
                
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    text = result.candidates[0].content.parts[0].text;
                    
                    // Add AI response to conversation history
                    conversationHistory.push({
                        role: 'assistant',
                        content: text
                    });
                    
                    // Show AI response in UI
                    appendMessageToUI(text, 'ai');
                    
                    // Save to storage
                    await saveChatHistory();
                } else {
                    appendMessageToUI(text, 'ai');
                }
                
            } catch (error) {
                console.error("Error:", error);
                appendMessageToUI("Sorry, there was an error. Please check your connection and try again.", 'ai');
            } finally {
                setUILoading(false);
            }
        }
        
        // Insert example
        window.insertExample = function(exampleText) {
            promptInput.value = exampleText;
            promptInput.focus();
            autoResize(promptInput);
            closeSidebarFunc();
        };
        
        // Generate content
        window.generateContent = function() {
            const userQuery = promptInput.value.trim();
            
            if (!userQuery) {
                promptInput.classList.add('border-red-500');
                setTimeout(() => promptInput.classList.remove('border-red-500'), 1000);
                return;
            }
            
            // Remove welcome message on first user message
            const welcomeMsg = document.querySelector('.message-container:first-child');
            if (welcomeMsg && conversationHistory.length === 0) {
                welcomeMsg.style.display = 'none';
            }
            
            // Show user message in UI
            appendMessageToUI(userQuery, 'user');
            
            promptInput.value = '';
            promptInput.style.height = 'auto';
            
            setTimeout(() => {
                fetchContent(userQuery);
            }, 300);
        };
        
        // Clear chat
        async function clearChat() {
            const messages = chatLog.querySelectorAll('.message-container, #typingIndicator');
            messages.forEach(msg => {
                msg.remove();
            });
            
            // Show welcome message
            const welcomeMsg = document.querySelector('.message-container:first-child');
            if (welcomeMsg) {
                welcomeMsg.style.display = 'block';
            }
            
            // Clear conversation history
            conversationHistory = [];
            
            // Remove from storage
            const allChats = await loadFromStorage(STORAGE_KEYS.CHAT_HISTORY) || {};
            delete allChats[currentChatId];
            await saveToStorage(STORAGE_KEYS.CHAT_HISTORY, allChats);
            
            // Update context memory indicator
            updateContextMemoryIndicator();
            
            showNotification("Chat cleared successfully");
            closeSidebarFunc();
        }
        
        // New chat
        async function newChat() {
            if (conversationHistory.length > 0) {
                if (confirm("Start a new chat? Current conversation will be saved.")) {
                    // Save current chat
                    await saveChatHistory();
                    
                    // Create new chat
                    currentChatId = `chat_${Date.now()}`;
                    conversationHistory = [];
                    
                    // Clear UI
                    const messages = chatLog.querySelectorAll('.message-container, #typingIndicator');
                    messages.forEach(msg => {
                        msg.remove();
                    });
                    
                    // Show welcome message
                    const welcomeMsg = document.querySelector('.message-container:first-child');
                    if (welcomeMsg) {
                        welcomeMsg.style.display = 'block';
                        chatLog.appendChild(welcomeMsg.cloneNode(true));
                    }
                    
                    // Update context memory indicator
                    updateContextMemoryIndicator();
                    
                    showNotification("New chat started");
                }
            }
            closeSidebarFunc();
        }
        
        // Event Listeners
        promptInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                generateContent();
            }
        });
        
        // Mobile menu
        mobileMenuBtn.addEventListener('click', toggleSidebar);
        closeSidebar.addEventListener('click', closeSidebarFunc);
        sidebarOverlay.addEventListener('click', closeSidebarFunc);
        
        clearChatBtn.addEventListener('click', function() {
            deleteModal.classList.remove('hidden');
            closeSidebarFunc();
        });
        
        cancelDelete.addEventListener('click', function() {
            deleteModal.classList.add('hidden');
        });
        
        confirmDelete.addEventListener('click', function() {
            deleteModal.classList.add('hidden');
            clearChat();
        });
        
        newChatBtn.addEventListener('click', newChat);
        
        deepThinkSideBtn.addEventListener('click', toggleDeepThinkMode);
        
        settingsBtn.addEventListener('click', function() {
            settingsModal.classList.remove('hidden');
            closeSidebarFunc();
        });
        
        closeSettings.addEventListener('click', function() {
            settingsModal.classList.add('hidden');
        });
        
        cancelSettings.addEventListener('click', function() {
            settingsModal.classList.add('hidden');
        });
        
        saveSettings.addEventListener('click', function() {
            saveCurrentSettings();
            settingsModal.classList.add('hidden');
        });
        
        // Context memory size slider
        contextMemorySize.addEventListener('input', function() {
            const value = this.value;
            contextMemoryValue.textContent = `${value} messages`;
            welcomeMemorySize.textContent = value;
        });
        
        // Close modals on outside click
        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) {
                deleteModal.classList.add('hidden');
            }
        });
        
        settingsModal.addEventListener('click', function(e) {
            if (e.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            checkMobile();
            if (!isMobile && sidebarDrawer.classList.contains('open')) {
                closeSidebarFunc();
            }
        });
        
        // Initialize
        window.addEventListener('DOMContentLoaded', async function() {
            await loadSettings();
            await loadChatHistory();
            
            setTimeout(() => promptInput.focus(), 300);
            
            // Check if mobile
            checkMobile();
            
            // Initial context memory indicator update
            updateContextMemoryIndicator();
            
            // Show Telegram user info if available
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                console.log("Telegram User:", user);
            }
        });

    </script>
</body>
</html>
