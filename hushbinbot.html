<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HushBin | AI Assistant</title>
    <!-- Telegram WebApp API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#0ea5e9',
                        'deep-think': '#8b5cf6',
                        'sidebar': '#202123',
                        'chat-bg': '#343541',
                        'input-bg': '#40414f',
                        'feature-blue': '#2563eb',
                        'feature-purple': '#7c3aed',
                        'feature-green': '#059669',
                        'feature-yellow': '#d97706',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #343541;
            color: white;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Hide scrollbar but allow scrolling */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* Scrollable content */
        .scrollable-content {
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        /* Mobile sidebar drawer */
        .sidebar-drawer {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-drawer.open {
            transform: translateX(0);
        }
        .sidebar-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Chat container */
        .chat-container {
            height: 100vh;
            background: #343541;
        }
        
        /* Message styles */
        .message-container {
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .message-content {
            max-width: 48rem;
            margin: 0 auto;
            padding: 0 16px;
            display: flex;
            gap: 20px;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background: #10a37f;
        }
        
        .ai-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .message-text {
            flex: 1;
            line-height: 1.75;
            color: #d1d5db;
            font-size: 16px;
            padding-top: 4px;
        }
        
        /* Input area - Mobile optimized */
        .input-container {
            background: #343541;
            padding: 16px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .input-wrapper {
            max-width: 48rem;
            margin: 0 auto;
            position: relative;
        }
        
        .message-input {
            width: 100%;
            background: #40414f;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px 20px;
            padding-right: 56px;
            padding-left: 56px;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            color: white;
            min-height: 52px;
            max-height: 120px;
        }
        
        .message-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .message-input::placeholder {
            color: #8e8ea0;
        }
        
        /* Send button */
        .send-button {
            position: absolute;
            right: 12px;
            bottom: 12px;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: #10a37f;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Deep Think Button - Left side of input */
        .deep-think-side-btn {
            position: absolute;
            left: 12px;
            bottom: 12px;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(139, 92, 246, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .deep-think-side-btn:hover {
            background: rgba(139, 92, 246, 0.2);
        }
        
        .deep-think-side-btn.active {
            background: rgba(139, 92, 246, 0.3);
            color: white;
            border-color: #8b5cf6;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #8e8ea0;
            animation: typing 1.5s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 100% { opacity: 0.5; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-4px); }
        }
        
        /* Mobile menu button */
        .mobile-menu-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            cursor: pointer;
        }
        
        /* Mobile responsive */
        @media (max-width: 640px) {
            .message-content {
                padding: 0 12px;
                gap: 12px;
            }
            
            .avatar {
                width: 32px;
                height: 32px;
            }
            
            .message-text {
                font-size: 15px;
            }
            
            .input-container {
                padding: 12px;
            }
            
            .message-input {
                padding-left: 52px;
                padding-right: 52px;
            }
        }
        
        /* AI response formatting */
        .ai-content {
            line-height: 1.75;
        }
        
        .ai-content p {
            margin-bottom: 16px;
        }
        
        .ai-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
        }
        
        .ai-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
        }
        
        .ai-content ul, .ai-content ol {
            padding-left: 20px;
            margin: 12px 0;
        }
        
        .ai-content li {
            margin-bottom: 8px;
        }
        
        /* Notification */
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Context Memory Indicator */
        .context-memory-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #10a37f;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 30;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(16, 163, 127, 0.3);
        }
        
        @media (max-width: 640px) {
            .context-memory-indicator {
                top: 60px;
                right: 10px;
                font-size: 11px;
                padding: 4px 8px;
            }
        }
        
        /* Feature Cards */
        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        
        .feature-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        .feature-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .feature-blue { background: rgba(37, 99, 235, 0.2); border: 1px solid rgba(37, 99, 235, 0.3); }
        .feature-purple { background: rgba(124, 58, 237, 0.2); border: 1px solid rgba(124, 58, 237, 0.3); }
        .feature-green { background: rgba(5, 150, 105, 0.2); border: 1px solid rgba(5, 150, 105, 0.3); }
        .feature-yellow { background: rgba(217, 119, 6, 0.2); border: 1px solid rgba(217, 119, 6, 0.3); }
        
        /* Creator Badge */
        .creator-badge {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #8b5cf6;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }
        
        /* Memory Badge */
        .memory-badge {
            background: rgba(16, 163, 127, 0.1);
            border: 1px solid rgba(16, 163, 127, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #10a37f;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Backup Badge */
        .backup-badge {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #8b5cf6;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }
        
        /* Chat List Item */
        .chat-list-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .chat-list-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .chat-list-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        /* Delete Chat Button */
        .delete-chat-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .chat-list-item:hover .delete-chat-btn {
            opacity: 0.7;
        }
        
        .chat-list-item:hover .delete-chat-btn:hover {
            opacity: 1;
            color: #ef4444;
        }
        
        /* Modal Scroll Fix */
        .modal-content-scroll {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 4px;
        }
        
        /* Scrollbar styling for modals */
        .modal-content-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .modal-content-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        .modal-content-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .modal-content-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Modal height fix for mobile */
        @media (max-height: 700px) {
            .modal-content-scroll {
                max-height: 60vh;
            }
        }
        
        @media (max-height: 600px) {
            .modal-content-scroll {
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <!-- Context Memory Indicator -->
    <div id="contextMemoryIndicator" class="context-memory-indicator hidden">
        <i class="fas fa-database"></i>
        <span id="contextCount">0 messages in memory</span>
    </div>

    <!-- Sidebar Drawer for Mobile -->
    <div id="sidebarOverlay" class="fixed inset-0 z-40 sidebar-overlay hidden"></div>
    <div id="sidebarDrawer" class="sidebar-drawer fixed inset-y-0 left-0 z-50 w-64 bg-[#202123] overflow-y-auto hide-scrollbar">
        <div class="p-4">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <span class="text-white font-semibold">HushBin</span>
                </div>
                <button id="closeSidebar" class="md:hidden p-2 text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- New Chat Button -->
            <button id="newChatBtn" class="w-full mb-4 p-3 text-left text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg border border-gray-700 flex items-center justify-between">
                <span class="flex items-center">
                    <i class="fas fa-plus mr-2"></i>New chat
                </span>
                <i class="fas fa-edit text-sm"></i>
            </button>
            
            <!-- Chat History List -->
            <div id="chatHistoryList" class="space-y-1 mb-8 max-h-96 overflow-y-auto hide-scrollbar">
                <!-- Chat list will be populated here -->
            </div>
            
            <!-- Quick Prompts -->
            <div class="space-y-3 mb-8">
                <div class="text-sm text-gray-400 mb-2">Quick Prompts</div>
                
                <div class="p-3 bg-gray-800/50 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-800" onclick="insertExample('Write a professional email to schedule a team meeting about Q4 goals')">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-envelope text-blue-400 mr-2"></i>
                        <span class="text-white">Professional Email</span>
                    </div>
                    <p class="text-xs text-gray-400">Business communication</p>
                </div>
                
                <div class="p-3 bg-gray-800/50 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-800" onclick="insertExample('Write a short fantasy story about a lost kingdom')">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-book text-purple-400 mr-2"></i>
                        <span class="text-white">Story Writing</span>
                    </div>
                    <p class="text-xs text-gray-400">Creative storytelling</p>
                </div>
                
                <div class="p-3 bg-gray-800/50 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-800" onclick="insertExample('Generate a business idea for sustainable tech in 2024')">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-lightbulb text-green-400 mr-2"></i>
                        <span class="text-white">Business Idea</span>
                    </div>
                    <p class="text-xs text-gray-400">Startup suggestions</p>
                </div>
                
                <div class="p-3 bg-gray-800/50 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-800" onclick="insertExample('How can we reduce employee turnover in our company?')">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-puzzle-piece text-yellow-400 mr-2"></i>
                        <span class="text-white">Problem Solving</span>
                    </div>
                    <p class="text-xs text-gray-400">Find solutions</p>
                </div>
            </div>
            
            <!-- Settings -->
            <div class="space-y-2">
                <button id="settingsBtn" class="w-full p-3 text-left text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
                <button id="clearChatBtn" class="w-full p-3 text-left text-gray-300 hover:text-red-400 hover:bg-gray-800 rounded-lg">
                    <i class="fas fa-trash mr-2"></i>Clear Current Chat
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 hidden">
        <div class="bg-[#202123] rounded-lg max-w-md w-full max-h-[85vh] flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-white">Settings</h2>
                    <button id="closeSettings" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="modal-content-scroll p-6">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Assistant Name</label>
                        <input id="aiName" type="text" class="w-full px-4 py-2.5 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-gray-600" value="HushBin">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Base Instructions (Optional)</label>
                        <textarea id="baseInstructions" rows="4" class="w-full px-4 py-2.5 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-gray-600 resize-none" placeholder="Add custom instructions for the AI assistant. Leave empty for default behavior."></textarea>
                        <p class="text-xs text-gray-400 mt-1">Note: If you want Islamic-minded responses, add instructions here</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Deep Think Instructions</label>
                        <textarea id="deepThinkInstructions" rows="4" class="w-full px-4 py-2.5 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-gray-600 resize-none">When Deep Think mode is enabled, provide more detailed, analytical, and comprehensive responses. Break down complex topics step by step, consider multiple perspectives, and provide thorough explanations.</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Context Memory Size</label>
                        <div class="flex items-center gap-4">
                            <input type="range" id="contextMemorySize" min="5" max="50" value="10" class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <span id="contextMemoryValue" class="text-green-400 font-medium">10 messages</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Number of previous messages to remember</p>
                    </div>
                    
                    <!-- Storage Status -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Storage Status</label>
                        <div id="storageStatus" class="p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-300">Chats Saved</span>
                                <span id="historyStatus" class="text-green-400 text-sm">Loading...</span>
                            </div>
                            <div class="text-xs text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                <span id="storageInfo">Chats are saved locally in your browser</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export/Import Chats -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Backup & Restore</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="exportChatsBtn" class="px-3 py-2 bg-blue-600/20 text-blue-400 rounded-lg hover:bg-blue-600/30 border border-blue-600/30 flex items-center justify-center gap-2">
                                <i class="fas fa-download"></i>
                                <span>Export</span>
                            </button>
                            <button id="importChatsBtn" class="px-3 py-2 bg-purple-600/20 text-purple-400 rounded-lg hover:bg-purple-600/30 border border-purple-600/30 flex items-center justify-center gap-2">
                                <i class="fas fa-upload"></i>
                                <span>Import</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Export your chats to a file or import from a backup</p>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-800 flex justify-end space-x-3">
                <button id="cancelSettings" class="px-4 py-2 text-gray-300 hover:text-white">Cancel</button>
                <button id="saveSettings" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 hidden">
        <div class="bg-[#202123] rounded-lg max-w-md w-full p-6">
            <div class="w-12 h-12 rounded-full bg-red-900/30 flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash text-red-500"></i>
            </div>
            <h2 class="text-xl font-semibold text-white text-center mb-2">Clear Current Chat?</h2>
            <p class="text-gray-400 text-center mb-6">This will delete all messages in the current conversation.</p>
            <div class="flex space-x-3">
                <button id="cancelDelete" class="flex-1 px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg">
                    Cancel
                </button>
                <button id="confirmDelete" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Chat Confirmation Modal -->
    <div id="deleteChatModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 hidden">
        <div class="bg-[#202123] rounded-lg max-w-md w-full p-6">
            <div class="w-12 h-12 rounded-full bg-red-900/30 flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash text-red-500"></i>
            </div>
            <h2 class="text-xl font-semibold text-white text-center mb-2">Delete Chat?</h2>
            <p id="deleteChatMessage" class="text-gray-400 text-center mb-6">This will permanently delete this chat.</p>
            <div class="flex space-x-3">
                <button id="cancelDeleteChat" class="flex-1 px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-800 rounded-lg">
                    Cancel
                </button>
                <button id="confirmDeleteChat" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Import Chat Modal -->
    <div id="importModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 hidden">
        <div class="bg-[#202123] rounded-lg max-w-md w-full max-h-[85vh] flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-white">Import Chats</h2>
                    <button id="closeImport" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="modal-content-scroll p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Select Backup File</label>
                        <div class="border-2 border-dashed border-gray-700 rounded-lg p-6 text-center cursor-pointer hover:border-gray-600 transition-colors" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-500 mb-3"></i>
                            <p class="text-gray-400">Click to select backup file</p>
                            <p class="text-xs text-gray-500 mt-1">JSON file exported from HushBin</p>
                        </div>
                        <input type="file" id="fileInput" accept=".json" class="hidden">
                    </div>
                    
                    <div id="importPreview" class="hidden p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <h3 class="text-white font-medium mb-2">Preview:</h3>
                        <div id="previewContent" class="text-sm text-gray-400"></div>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-800 flex justify-end space-x-3">
                <button id="cancelImport" class="px-4 py-2 text-gray-300 hover:text-white">Cancel</button>
                <button id="confirmImport" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" disabled>Import</button>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-container flex flex-col">
        <!-- Header -->
        <header class="px-4 py-3 border-b border-gray-800 bg-[#343541] flex items-center justify-between md:justify-center">
            <button id="mobileMenuBtn" class="md:hidden mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <span id="aiTitle" class="text-white font-medium">HushBin</span>
                <span id="currentChatTitle" class="text-gray-400 text-sm hidden md:inline">- New Chat</span>
            </div>
            
            <div class="w-10 md:hidden"></div> <!-- Spacer for alignment -->
        </header>

        <!-- Messages Area -->
        <div id="chatLog" class="flex-1 overflow-y-auto hide-scrollbar pb-40">
            <!-- Welcome Message -->
            <div class="message-container" style="border-bottom: none;">
                <div class="message-content">
                    <div class="avatar ai-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-text">
                        <div class="ai-content">
                            <!-- Main Title -->
                            <div class="mb-6">
                                <h1 class="text-2xl font-bold text-white mb-2">Hello! I'm <span class="bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">HushBin</span> ðŸ‘‹</h1>
                                <div class="creator-badge">
                                    <i class="fas fa-code"></i>
                                    <span>By <a href="https://t.me/sakibalhasannaim" target="_blank" class="hover:text-white transition-colors">Sakib Al Hasan Naim</a></span>
                                </div>
                            </div>
                            
                            <!-- Introduction -->
                            <p class="text-gray-300 mb-6">I'm your AI assistant here to help with various tasks. Let's explore what I can do for you!</p>
                            
                            <!-- Feature Cards -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                <!-- Professional Email -->
                                <div class="feature-card">
                                    <div class="feature-icon feature-blue">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <h3 class="font-semibold text-white mb-1">Professional Email</h3>
                                    <p class="text-sm text-gray-400">Craft business communications with professional tone</p>
                                </div>
                                
                                <!-- Story Writing -->
                                <div class="feature-card">
                                    <div class="feature-icon feature-purple">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <h3 class="font-semibold text-white mb-1">Story Writing</h3>
                                    <p class="text-sm text-gray-400">Create engaging stories and creative content</p>
                                </div>
                                
                                <!-- Business Idea -->
                                <div class="feature-card">
                                    <div class="feature-icon feature-green">
                                        <i class="fas fa-lightbulb"></i>
                                    </div>
                                    <h3 class="font-semibold text-white mb-1">Business Idea</h3>
                                    <p class="text-sm text-gray-400">Generate innovative startup suggestions</p>
                                </div>
                                
                                <!-- Problem Solving -->
                                <div class="feature-card">
                                    <div class="feature-icon feature-yellow">
                                        <i class="fas fa-puzzle-piece"></i>
                                    </div>
                                    <h3 class="font-semibold text-white mb-1">Problem Solving</h3>
                                    <p class="text-sm text-gray-400">Find solutions to complex challenges</p>
                                </div>
                            </div>
                            
                            <!-- Memory Badge -->
                            <div class="memory-badge">
                                <i class="fas fa-brain"></i>
                                <span>Remembers <span id="welcomeMemorySize" class="font-bold">10</span> previous messages</span>
                            </div>
                            
                            <!-- Quick Start -->
                            <p class="text-sm text-gray-400 mt-6">
                                <i class="fas fa-bolt text-yellow-400 mr-1"></i>
                                Pro tip: Click "New chat" in sidebar to start fresh, or try the quick prompts!
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <div class="input-wrapper">
                <!-- Deep Think Button on Left -->
                <button id="deepThinkSideBtn" class="deep-think-side-btn" title="Toggle Deep Think Mode">
                    <i class="fas fa-brain"></i>
                </button>
                
                <textarea id="promptInput" rows="1"
                    class="message-input resize-none focus:outline-none focus:ring-0"
                    placeholder="Type your message here..."
                    oninput="autoResize(this)"></textarea>
                
                <button id="sendBtn"
                    class="send-button"
                    onclick="generateContent()">
                    <i id="sendIcon" class="fas fa-paper-plane"></i>
                    <i id="loadingSpinner" class="fas fa-spinner fa-spin hidden"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // API Configuration
        const apiKey = "AIzaSyDUUaYAHFYJEDy6TyRRk3kwyAW9Bl86gvA";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

        // DOM Elements
        const promptInput = document.getElementById('promptInput');
        const sendBtn = document.getElementById('sendBtn');
        const sendIcon = document.getElementById('sendIcon');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const chatLog = document.getElementById('chatLog');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebarDrawer = document.getElementById('sidebarDrawer');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const closeSidebar = document.getElementById('closeSidebar');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const deepThinkSideBtn = document.getElementById('deepThinkSideBtn');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const cancelSettings = document.getElementById('cancelSettings');
        const saveSettings = document.getElementById('saveSettings');
        const aiName = document.getElementById('aiName');
        const baseInstructions = document.getElementById('baseInstructions');
        const deepThinkInstructions = document.getElementById('deepThinkInstructions');
        const aiTitle = document.getElementById('aiTitle');
        const contextMemoryIndicator = document.getElementById('contextMemoryIndicator');
        const contextCount = document.getElementById('contextCount');
        const contextMemorySize = document.getElementById('contextMemorySize');
        const contextMemoryValue = document.getElementById('contextMemoryValue');
        const welcomeMemorySize = document.getElementById('welcomeMemorySize');
        const chatHistoryList = document.getElementById('chatHistoryList');
        const currentChatTitle = document.getElementById('currentChatTitle');
        const storageStatus = document.getElementById('storageStatus');
        const historyStatus = document.getElementById('historyStatus');
        const storageInfo = document.getElementById('storageInfo');
        const exportChatsBtn = document.getElementById('exportChatsBtn');
        const importChatsBtn = document.getElementById('importChatsBtn');
        const deleteChatModal = document.getElementById('deleteChatModal');
        const cancelDeleteChat = document.getElementById('cancelDeleteChat');
        const confirmDeleteChat = document.getElementById('confirmDeleteChat');
        const deleteChatMessage = document.getElementById('deleteChatMessage');
        const importModal = document.getElementById('importModal');
        const closeImport = document.getElementById('closeImport');
        const cancelImport = document.getElementById('cancelImport');
        const confirmImport = document.getElementById('confirmImport');
        const fileInput = document.getElementById('fileInput');
        const importPreview = document.getElementById('importPreview');
        const previewContent = document.getElementById('previewContent');
        
        // State
        let isDeepThinkMode = false;
        let isMobile = window.innerWidth < 768;
        let maxContextMemory = 10;
        
        // Chat Management
        let chats = []; // Array of chat objects
        let currentChatId = null; // ID of current chat
        
        // Chat Object Structure:
        // {
        //   id: 'unique-id',
        //   title: 'Chat Title',
        //   messages: [{role: 'user'|'assistant', content: '...'}],
        //   createdAt: timestamp,
        //   updatedAt: timestamp
        // }
        
        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        // Check if mobile
        function checkMobile() {
            isMobile = window.innerWidth < 768;
        }
        
        // Toggle sidebar
        function toggleSidebar() {
            sidebarDrawer.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
            document.body.style.overflow = sidebarDrawer.classList.contains('open') ? 'hidden' : '';
            
            // Refresh chat list when opening sidebar
            if (sidebarDrawer.classList.contains('open')) {
                updateStorageStatus();
            }
        }
        
        // Close sidebar
        function closeSidebarFunc() {
            sidebarDrawer.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        // Load settings
        function loadSettings() {
            const savedName = localStorage.getItem('hushBinName') || 'HushBin';
            const savedBaseInstructions = localStorage.getItem('baseInstructions') || '';
            const savedDeepThinkInstructions = localStorage.getItem('deepThinkInstructions') || deepThinkInstructions.value;
            const savedMaxContextMemory = localStorage.getItem('maxContextMemory') || 10;
            
            aiName.value = savedName;
            baseInstructions.value = savedBaseInstructions;
            deepThinkInstructions.value = savedDeepThinkInstructions;
            contextMemorySize.value = savedMaxContextMemory;
            contextMemoryValue.textContent = `${savedMaxContextMemory} messages`;
            welcomeMemorySize.textContent = savedMaxContextMemory;
            maxContextMemory = parseInt(savedMaxContextMemory);
            
            aiTitle.textContent = savedName;
        }
        
        // Save settings
        function saveCurrentSettings() {
            localStorage.setItem('hushBinName', aiName.value);
            localStorage.setItem('baseInstructions', baseInstructions.value);
            localStorage.setItem('deepThinkInstructions', deepThinkInstructions.value);
            localStorage.setItem('maxContextMemory', contextMemorySize.value);
            
            maxContextMemory = parseInt(contextMemorySize.value);
            contextMemoryValue.textContent = `${maxContextMemory} messages`;
            welcomeMemorySize.textContent = maxContextMemory;
            
            aiTitle.textContent = aiName.value;
            saveAllChats();
            showNotification("Settings saved successfully");
        }
        
        // Show notification
        function showNotification(message) {
            // Remove existing notification
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'notification fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2.5 bg-[#202123] text-white rounded-lg text-sm shadow-lg border border-gray-800';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }
        
        // Toggle Deep Think mode
        function toggleDeepThinkMode() {
            isDeepThinkMode = !isDeepThinkMode;
            deepThinkSideBtn.classList.toggle('active', isDeepThinkMode);
            
            if (isDeepThinkMode) {
                deepThinkSideBtn.innerHTML = '<i class="fas fa-brain"></i>';
                deepThinkSideBtn.title = "Deep Think Mode ON";
                showNotification("Deep Think mode enabled - Detailed responses activated");
            } else {
                deepThinkSideBtn.innerHTML = '<i class="fas fa-brain"></i>';
                deepThinkSideBtn.title = "Toggle Deep Think Mode";
                showNotification("Deep Think mode disabled");
            }
        }
        
        // Get system instruction
        function getSystemInstruction() {
            const defaultInstruction = `You are HushBin (always spell it as HushBin in English), a helpful AI assistant created by Sakib Al Hasan Naim (Telegram: @sakibalhasannaim).

Your name is HushBin and you should always identify as HushBin.

Greeting Rules:
- When users greet you with Islamic greetings (such as Assalamu Alaikum, Salam, As-salamu alaykum, etc.), respond with appropriate Islamic greetings (like Wa Alaikum Assalam, Walaykumus Salam).
- For general greetings (like hi, hello, good morning, etc.), respond with general greetings (like Hello, Hi, Good morning) and then introduce yourself as HushBin.
- NEVER respond to general greetings like "hi" with Islamic greetings like "Walaykumus Salam". Only use Islamic greetings when the user uses them first.

Creator Information:
- When users ask about who created you or your creator, mention that you are created by Sakib Al Hasan Naim and provide the Telegram link: @sakibalhasannaim.
- Always give credit to your creator when appropriate.

General Behavior:
Be respectful and helpful in all responses. For Islamic topics, respond with appropriate Islamic knowledge. For general topics, be natural and helpful. Always spell your name as HushBin.`;

            let instruction = baseInstructions.value.trim();
            
            if (!instruction) {
                instruction = defaultInstruction;
            }
            
            if (isDeepThinkMode) {
                instruction += "\n\n" + deepThinkInstructions.value;
            }
            
            return instruction;
        }
        
        // Save all chats to localStorage
        function saveAllChats() {
            try {
                const data = {
                    chats: chats,
                    currentChatId: currentChatId,
                    version: '2.0'
                };
                localStorage.setItem('hushbin_chats_data', JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving chats:', error);
                showNotification("Error saving chats");
                return false;
            }
        }
        
        // Load all chats from localStorage
        function loadAllChats() {
            try {
                const savedData = localStorage.getItem('hushbin_chats_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Handle migration from old version if needed
                    if (data.version === '2.0' && Array.isArray(data.chats)) {
                        chats = data.chats;
                        currentChatId = data.currentChatId;
                        return true;
                    }
                }
            } catch (error) {
                console.error('Error loading chats:', error);
            }
            
            // If no saved chats or error, create first chat
            createNewChat();
            return false;
        }
        
        // Create a new chat
        function createNewChat() {
            const newChat = {
                id: generateId(),
                title: 'New Chat',
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            chats.unshift(newChat); // Add to beginning
            currentChatId = newChat.id;
            
            saveAllChats();
            renderChatList();
            clearChatUI();
            
            currentChatTitle.textContent = `- ${newChat.title}`;
            currentChatTitle.classList.remove('hidden');
            
            showNotification("New chat created");
            return newChat.id;
        }
        
        // Switch to a chat
        function switchToChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            
            currentChatId = chatId;
            saveAllChats();
            renderChatUI(chat);
            renderChatList();
            
            currentChatTitle.textContent = `- ${chat.title}`;
            currentChatTitle.classList.remove('hidden');
            
            closeSidebarFunc();
        }
        
        // Update chat title from first message
        function updateChatTitle(chatId, firstMessage) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            
            if (firstMessage) {
                // Truncate long titles
                const title = firstMessage.length > 30 
                    ? firstMessage.substring(0, 30) + '...' 
                    : firstMessage;
                chat.title = title;
                chat.updatedAt = new Date().toISOString();
                
                if (chatId === currentChatId) {
                    currentChatTitle.textContent = `- ${title}`;
                }
                
                saveAllChats();
                renderChatList();
            }
        }
        
        // Delete a chat
        function deleteChat(chatId) {
            if (chats.length <= 1) {
                showNotification("Cannot delete the only chat");
                return;
            }
            
            const index = chats.findIndex(c => c.id === chatId);
            if (index === -1) return;
            
            const deletedChat = chats[index];
            chats.splice(index, 1);
            
            // If deleting current chat, switch to another
            if (chatId === currentChatId) {
                if (chats.length > 0) {
                    switchToChat(chats[0].id);
                } else {
                    createNewChat();
                }
            }
            
            saveAllChats();
            renderChatList();
            showNotification(`Deleted "${deletedChat.title}"`);
        }
        
        // Render chat list in sidebar
        function renderChatList() {
            chatHistoryList.innerHTML = '';
            
            if (chats.length === 0) {
                chatHistoryList.innerHTML = `
                    <div class="text-center py-4 text-gray-500 text-sm">
                        No chats yet
                    </div>
                `;
                return;
            }
            
            chats.forEach(chat => {
                const chatElement = document.createElement('div');
                chatElement.className = `chat-list-item ${chat.id === currentChatId ? 'active' : ''}`;
                chatElement.onclick = () => switchToChat(chat.id);
                
                const timeAgo = getTimeAgo(new Date(chat.updatedAt));
                
                chatElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1 min-w-0">
                            <div class="text-white truncate">${chat.title}</div>
                            <div class="text-xs text-gray-400 mt-1">${timeAgo}</div>
                        </div>
                        <button class="delete-chat-btn text-gray-500 hover:text-red-400 p-1" 
                                onclick="event.stopPropagation(); showDeleteChatModal('${chat.id}', '${chat.title.replace(/'/g, "\\'")}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                chatHistoryList.appendChild(chatElement);
            });
        }
        
        // Render chat UI
        function renderChatUI(chat) {
            // Clear current chat UI
            clearChatUI();
            
            // Hide welcome message if there are messages
            if (chat.messages.length > 0) {
                const welcomeMsg = document.querySelector('.message-container:first-child');
                if (welcomeMsg) {
                    welcomeMsg.style.display = 'none';
                }
            }
            
            // Render all messages
            chat.messages.forEach(msg => {
                appendMessage(msg.content, msg.role, false);
            });
            
            // Update context indicator
            updateContextMemoryIndicator();
        }
        
        // Clear chat UI (keep welcome message)
        function clearChatUI() {
            const messages = chatLog.querySelectorAll('.message-container:not(:first-child), #typingIndicator');
            messages.forEach(msg => {
                msg.remove();
            });
            
            // Show welcome message
            const welcomeMsg = document.querySelector('.message-container:first-child');
            if (welcomeMsg) {
                welcomeMsg.style.display = 'block';
            }
            
            updateContextMemoryIndicator();
        }
        
        // Clear current chat messages
        function clearCurrentChat() {
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return;
            
            chat.messages = [];
            chat.title = 'New Chat';
            chat.updatedAt = new Date().toISOString();
            
            saveAllChats();
            clearChatUI();
            renderChatList();
            
            currentChatTitle.textContent = `- New Chat`;
            showNotification("Current chat cleared");
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }
        
        // Update storage status display
        function updateStorageStatus() {
            const chatCount = chats.length;
            const totalMessages = chats.reduce((sum, chat) => sum + chat.messages.length, 0);
            
            if (chatCount > 0) {
                historyStatus.textContent = `${chatCount} chats, ${totalMessages} messages`;
                historyStatus.className = 'text-green-400 text-sm';
                storageInfo.textContent = 'Chats are saved locally in your browser';
            } else {
                historyStatus.textContent = 'No chats saved';
                historyStatus.className = 'text-gray-400 text-sm';
                storageInfo.textContent = 'Chats are saved locally in your browser';
            }
        }
        
        // Update context memory indicator
        function updateContextMemoryIndicator() {
            const chat = chats.find(c => c.id === currentChatId);
            if (chat && chat.messages.length > 0) {
                contextMemoryIndicator.classList.remove('hidden');
                contextCount.textContent = `${chat.messages.length} messages in memory`;
            } else {
                contextMemoryIndicator.classList.add('hidden');
            }
        }
        
        // Append message UI only
        function appendMessage(text, sender, shouldSave = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-container';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = `avatar ${sender === 'user' ? 'user-avatar' : 'ai-avatar'}`;
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            messageContent.appendChild(avatar);
            
            // Message text
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'ai-content';
            
            // Format text
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
                
            contentDiv.innerHTML = `<p>${formattedText}</p>`;
            messageText.appendChild(contentDiv);
            messageContent.appendChild(messageText);
            messageDiv.appendChild(messageContent);
            chatLog.appendChild(messageDiv);
            
            // Scroll to bottom
            setTimeout(() => {
                chatLog.scrollTop = chatLog.scrollHeight;
            }, 10);
            
            // Update context memory indicator
            updateContextMemoryIndicator();
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) typingIndicator.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-container';
            messageDiv.id = 'typingIndicator';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar ai-avatar';
            avatar.innerHTML = '<i class="fas fa-robot"></i>';
            messageContent.appendChild(avatar);
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                typingDiv.appendChild(dot);
            }
            
            const typingText = document.createElement('span');
            typingText.className = 'ml-2 text-sm text-gray-400';
            typingText.textContent = isDeepThinkMode ? 'Thinking deeply...' : 'Thinking...';
            typingDiv.appendChild(typingText);
            
            messageText.appendChild(typingDiv);
            messageContent.appendChild(messageText);
            messageDiv.appendChild(messageContent);
            chatLog.appendChild(messageDiv);
            
            setTimeout(() => {
                chatLog.scrollTop = chatLog.scrollHeight;
            }, 10);
        }
        
        // Set loading state
        function setUILoading(isLoading) {
            sendBtn.disabled = isLoading;
            promptInput.disabled = isLoading;
            deepThinkSideBtn.disabled = isLoading;
            
            if (isLoading) {
                sendIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                showTypingIndicator();
            } else {
                sendIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
            }
        }
        
        // Get recent conversation history (respecting max context memory)
        function getRecentConversationHistory() {
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return [];
            
            const messages = chat.messages;
            if (messages.length <= maxContextMemory) {
                return messages;
            }
            
            // Keep only the most recent messages
            const recentHistory = messages.slice(-maxContextMemory);
            return recentHistory;
        }
        
        // Fetch content from API
        async function fetchContent(userQuery) {
            setUILoading(true);
            
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return;
            
            // Add user message to conversation history
            chat.messages.push({
                role: 'user',
                content: userQuery
            });
            
            // Update chat title from first message if needed
            if (chat.messages.length === 1) {
                updateChatTitle(chat.id, userQuery);
            }
            
            // Update timestamp
            chat.updatedAt = new Date().toISOString();
            
            // Get recent history (respecting memory limit)
            const recentHistory = getRecentConversationHistory();
            
            // Prepare conversation history for API
            const contents = recentHistory.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: [{ text: msg.content }]
            }));
            
            const payload = {
                contents: contents,
                systemInstruction: { 
                    parts: [{ 
                        text: getSystemInstruction()
                    }] 
                },
                generationConfig: {
                    temperature: isDeepThinkMode ? 0.2 : 0.7,
                    maxOutputTokens: isDeepThinkMode ? 4000 : 2000,
                    topP: 0.95,
                    topK: 40
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                let text = "I apologize, I could not generate a response at this time. Please try again.";
                
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    text = result.candidates[0].content.parts[0].text;
                    
                    // Add AI response to conversation history
                    chat.messages.push({
                        role: 'assistant',
                        content: text
                    });
                    
                    // Show AI response in UI
                    appendMessage(text, 'ai');
                } else {
                    appendMessage(text, 'ai');
                }
                
            } catch (error) {
                console.error("Error:", error);
                appendMessage("Sorry, there was an error. Please check your connection and try again.", 'ai');
            } finally {
                setUILoading(false);
                saveAllChats();
                updateStorageStatus();
            }
        }
        
        // Insert example
        window.insertExample = function(exampleText) {
            promptInput.value = exampleText;
            promptInput.focus();
            autoResize(promptInput);
            closeSidebarFunc();
        };
        
        // Generate content
        window.generateContent = function() {
            const userQuery = promptInput.value.trim();
            
            if (!userQuery) {
                promptInput.classList.add('border-red-500');
                setTimeout(() => promptInput.classList.remove('border-red-500'), 1000);
                return;
            }
            
            // Remove welcome message on first user message
            const welcomeMsg = document.querySelector('.message-container:first-child');
            const chat = chats.find(c => c.id === currentChatId);
            if (welcomeMsg && chat && chat.messages.length === 0) {
                welcomeMsg.style.display = 'none';
            }
            
            // Show user message in UI
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message-container';
            
            const userMessageContent = document.createElement('div');
            userMessageContent.className = 'message-content';
            
            const userAvatar = document.createElement('div');
            userAvatar.className = 'avatar user-avatar';
            userAvatar.innerHTML = '<i class="fas fa-user"></i>';
            userMessageContent.appendChild(userAvatar);
            
            const userMessageText = document.createElement('div');
            userMessageText.className = 'message-text';
            userMessageText.innerHTML = `<div class="ai-content"><p>${userQuery}</p></div>`;
            userMessageContent.appendChild(userMessageText);
            userMessageDiv.appendChild(userMessageContent);
            chatLog.appendChild(userMessageDiv);
            
            promptInput.value = '';
            promptInput.style.height = 'auto';
            
            setTimeout(() => {
                fetchContent(userQuery);
            }, 300);
        };
        
        // Export chats to file
        function exportChats() {
            const data = {
                chats: chats,
                exportedAt: new Date().toISOString(),
                version: '2.0',
                app: 'HushBin'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hushbin-chats-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Chats exported successfully");
        }
        
        // Import chats from file
        function importChats(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate the imported data
                    if (!importedData.chats || !Array.isArray(importedData.chats)) {
                        throw new Error("Invalid backup file format");
                    }
                    
                    // Show preview
                    importPreview.classList.remove('hidden');
                    previewContent.innerHTML = `
                        <div class="mb-2">Chats to import: ${importedData.chats.length}</div>
                        <div class="text-xs text-gray-500">Exported: ${importedData.exportedAt ? new Date(importedData.exportedAt).toLocaleString() : 'Unknown'}</div>
                    `;
                    
                    // Store imported data and enable import button
                    window.importedChatsData = importedData;
                    confirmImport.disabled = false;
                    
                } catch (error) {
                    showNotification("Error reading backup file: " + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Confirm import
        function confirmImportChats() {
            if (!window.importedChatsData) return;
            
            // Add imported chats to existing chats
            const importedChats = window.importedChatsData.chats;
            
            // Generate new IDs for imported chats to avoid conflicts
            importedChats.forEach(chat => {
                chat.id = generateId();
                chat.createdAt = chat.createdAt || new Date().toISOString();
                chat.updatedAt = chat.updatedAt || new Date().toISOString();
            });
            
            // Add imported chats to beginning
            chats.unshift(...importedChats);
            
            // Switch to first imported chat
            if (importedChats.length > 0) {
                currentChatId = importedChats[0].id;
                switchToChat(currentChatId);
            }
            
            saveAllChats();
            renderChatList();
            updateStorageStatus();
            
            importModal.classList.add('hidden');
            showNotification(`Imported ${importedChats.length} chats successfully`);
            
            // Clean up
            delete window.importedChatsData;
        }
        
        // Show delete chat modal
        window.showDeleteChatModal = function(chatId, chatTitle) {
            deleteChatMessage.textContent = `This will permanently delete "${chatTitle}".`;
            deleteChatModal.classList.remove('hidden');
            
            // Store chat ID for deletion
            deleteChatModal.dataset.chatId = chatId;
        };
        
        // Event Listeners
        promptInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                generateContent();
            }
        });
        
        // Mobile menu
        mobileMenuBtn.addEventListener('click', toggleSidebar);
        closeSidebar.addEventListener('click', closeSidebarFunc);
        sidebarOverlay.addEventListener('click', closeSidebarFunc);
        
        clearChatBtn.addEventListener('click', function() {
            deleteModal.classList.remove('hidden');
            closeSidebarFunc();
        });
        
        cancelDelete.addEventListener('click', function() {
            deleteModal.classList.add('hidden');
        });
        
        confirmDelete.addEventListener('click', function() {
            deleteModal.classList.add('hidden');
            clearCurrentChat();
        });
        
        newChatBtn.addEventListener('click', function() {
            createNewChat();
            closeSidebarFunc();
        });
        
        deepThinkSideBtn.addEventListener('click', toggleDeepThinkMode);
        
        settingsBtn.addEventListener('click', function() {
            settingsModal.classList.remove('hidden');
            updateStorageStatus();
            closeSidebarFunc();
        });
        
        closeSettings.addEventListener('click', function() {
            settingsModal.classList.add('hidden');
        });
        
        cancelSettings.addEventListener('click', function() {
            settingsModal.classList.add('hidden');
        });
        
        saveSettings.addEventListener('click', function() {
            saveCurrentSettings();
            settingsModal.classList.add('hidden');
        });
        
        exportChatsBtn.addEventListener('click', exportChats);
        
        importChatsBtn.addEventListener('click', function() {
            importModal.classList.remove('hidden');
            importPreview.classList.add('hidden');
            confirmImport.disabled = true;
            fileInput.value = '';
        });
        
        closeImport.addEventListener('click', function() {
            importModal.classList.add('hidden');
        });
        
        cancelImport.addEventListener('click', function() {
            importModal.classList.add('hidden');
        });
        
        confirmImport.addEventListener('click', confirmImportChats);
        
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                importChats(e.target.files[0]);
            }
        });
        
        cancelDeleteChat.addEventListener('click', function() {
            deleteChatModal.classList.add('hidden');
        });
        
        confirmDeleteChat.addEventListener('click', function() {
            const chatId = deleteChatModal.dataset.chatId;
            deleteChatModal.classList.add('hidden');
            if (chatId) {
                deleteChat(chatId);
            }
        });
        
        // Context memory size slider
        contextMemorySize.addEventListener('input', function() {
            const value = this.value;
            contextMemoryValue.textContent = `${value} messages`;
            welcomeMemorySize.textContent = value;
        });
        
        // Close modals on outside click
        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) {
                deleteModal.classList.add('hidden');
            }
        });
        
        deleteChatModal.addEventListener('click', function(e) {
            if (e.target === deleteChatModal) {
                deleteChatModal.classList.add('hidden');
            }
        });
        
        settingsModal.addEventListener('click', function(e) {
            if (e.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });
        
        importModal.addEventListener('click', function(e) {
            if (e.target === importModal) {
                importModal.classList.add('hidden');
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            checkMobile();
            if (!isMobile && sidebarDrawer.classList.contains('open')) {
                closeSidebarFunc();
            }
        });
        
        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            
            // Load chats
            loadAllChats();
            
            // If no current chat, create one
            if (!currentChatId && chats.length > 0) {
                currentChatId = chats[0].id;
            }
            
            // Render current chat
            const currentChat = chats.find(c => c.id === currentChatId);
            if (currentChat) {
                renderChatUI(currentChat);
                currentChatTitle.textContent = `- ${currentChat.title}`;
                currentChatTitle.classList.remove('hidden');
            }
            
            // Render chat list
            renderChatList();
            
            setTimeout(() => promptInput.focus(), 300);
            
            // Check if mobile
            checkMobile();
            
            // Initial context memory indicator update
            updateContextMemoryIndicator();
            updateStorageStatus();
            
            // Initialize Telegram WebApp if available
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
            }
        });

    </script>
</body>
</html>